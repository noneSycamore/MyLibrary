
# python 文本编辑器的实现
## 前言
一个简单的文本编辑器，基本功能都有了，（￣︶￣）↗　
最满意的部分是，能显示行号，加了快捷键，还有查找功能的实现	(‾◡◝)
emm...
更改主题的功能感觉也不错，
就是感觉，自己搞的有点丑。。。<(＿　＿)>
## 系统概述
目标是设计开发一个简单的多文档文本编辑器SimpleMDIExample，
可以新建、打开、保存、另存为一个文本文件；
可对文本进行撤销、恢复、剪贴、复制、粘贴、全选操作；
拥有查找功能；
添加快捷键的方式实现以上功能；
可以选择显示行号，高亮当前行、更换编辑器主题。
## 系统设计
具体功能描述如下：
**打开已存在文档**：可以打开文本文档（不限txt格式），读取文件内容并将其显示在文本框中。
**新建文档**：标题置为New，并将文本编辑框处于空白状态。
**保存**（另存为）文档：将文本编辑框中的文本保存到文本文件中，可设置为任意类型的文件。
**撤销**：撤去文本框内前一步进行的操作。
**恢复**：恢复撤去的操作。
**剪贴**：删去选中的文字，并复制选中的文字到剪贴板；**复制**：复制选中的文字到剪贴板；**粘贴**：将复制的文字粘贴到文本框内对应位置；**全选**：选中文本框内全部的文字
**查找**：在文本框内搜索要查找的字符（串），并反馈字符（串）个数且高亮文本框内查找到的字符（串），退出查找功能后高亮消失。
**显示行号**：添加侧栏，记录文本框内已有文字的行号，实时更新。
**高亮当前行**：高亮光标所在行，并随光标上下移动实时改变。
**更换编辑器主题**：可以更换文本框以及侧边栏的背景颜色。
## 界面设计
1.主要页面：

![](https://cdn.jsdelivr.net/gh/noneSycamore/whitzard_cdn/wp-content/uploads/2021/09/editor1.png)

2.查找窗口：

![](https://cdn.jsdelivr.net/gh/noneSycamore/whitzard_cdn/wp-content/uploads/2021/09/editor2.png)

![](https://cdn.jsdelivr.net/gh/noneSycamore/whitzard_cdn/wp-content/uploads/2021/09/editor3.png)
## 代码实现
```python
from tkinter import *
from tkinter.ttk import Scrollbar
from tkinter import filedialog, messagebox
import os

theme_color = {  # line_bar,content
    'Default': '#DCDCDC.#FFFAFA',
    'lavender': '#F0F8FF.#E6E6FA',
    'SlateGray': '#9FB6CD.#B9D3EE',
    'Ivory': '#CDCDC1.#EEEEE0',
    'Honeydew': '#C1CDC1.#E0EEE0',
    'LavenderBlush': '#CDC1C5.#EEE0E5',
}

ICONS = ['new_file', 'open_file', 'save',
         'undo', 'redo', 'cut', 'copy', 'paste', 'find_text']

icon_tmp=[]

def Editor(root):
    # 创建菜单栏
    def create_menu():
        global Show_number,Theme_choice,Highlight
        menu = Menu(root)
        File_menu = Menu(menu, tearoff=0)
        File_menu.add_command(label='新建', accelerator='Ctrl+N', command=New_file)
        File_menu.add_command(label='打开', accelerator='Ctrl+O', command=Open_file)
        File_menu.add_command(label='保存', accelerator='Ctrl+S', command=Save_file)
        File_menu.add_command(label='另存为', accelerator='Shift+Ctrl+S', command=Save)
        File_menu.add_separator()
        File_menu.add_command(label='退出', accelerator='Alt+F4', command=Exit)

        # 文件菜单
        menu.add_cascade(label='文件', menu=File_menu)
        Edit_menu = Menu(menu, tearoff=0)
        Edit_menu.add_command(label='撤销', accelerator='Ctrl+Z', command=lambda :Edit('撤销'))
        Edit_menu.add_command(label='恢复', accelerator='Ctrl+Y / Shift+Ctrl+Z', command=lambda :Edit('恢复'))
        Edit_menu.add_separator()
        Edit_menu.add_command(label='剪切', accelerator='Ctrl+X', command=lambda :Edit('剪切'))
        Edit_menu.add_command(label='复制', accelerator='Ctrl+C', command=lambda :Edit('复制'))
        Edit_menu.add_command(label='粘贴', accelerator='Ctrl+V', command=lambda :Edit('粘贴'))
        Edit_menu.add_separator()
        Edit_menu.add_command(label='查找', accelerator='Ctrl+F', command=find_text)
        Edit_menu.add_separator()
        Edit_menu.add_command(label='全选', accelerator='Ctrl+A', command=All)
        menu.add_cascade(label='编辑', menu=Edit_menu)

        # 视图菜单
        View_menu = Menu(menu, tearoff=0)
        Show_number = IntVar()
        Show_number.set(0)
        View_menu.add_checkbutton(label='显示行号', variable=Show_number,
            command=If_update)
        Highlight = IntVar()
        Highlight.set(0)
        View_menu.add_checkbutton(label='高亮当前行', onvalue=1, offvalue=0, \
            variable=Highlight, command=Highlight_line)
        # 视图内创建主题副菜单
        Themes_menu = Menu(menu, tearoff=0)
        View_menu.add_cascade(label='主题', menu=Themes_menu)
        Theme_choice = StringVar()
        Theme_choice.set('Default')
        for k in sorted(theme_color):
            Themes_menu.add_radiobutton(label=k, variable=Theme_choice, command=change_theme)
        menu.add_cascade(label='视图', menu=View_menu)

        root["menu"] = menu

    # 创建快捷菜单栏
    def create_shortcut():
        shortcut = Frame(root, height=25, background='#FDF5E6')
        shortcut.pack(fill='x')

        for i, icon in enumerate(ICONS):
            tool_icon = PhotoImage(file='img/%s.gif' % (icon,))
            tool_botton = Button(shortcut, image=tool_icon,
                          command=shortcut_action(icon))

            tool_botton.pack(side='left')
            icon_tmp.append(tool_icon)

    def shortcut_action(types, event=None):
        def tmp():
            if (types == "new_file"):
                New_file()
            elif (types == "open_file"):
                Open_file()
            elif (types == "save"):
                Save_file()
            elif (types == "undo"):
                content.event_generate("<<Undo>>")
            elif (types == "redo"):
                content.event_generate("<<Redo>>")
            elif (types == "cut"):
                content.event_generate("<<Cut>>")
            elif (types == "copy"):
                content.event_generate("<<Copy>>")
            elif (types == "paste"):
                content.event_generate("<<Paste>>")
            elif (types == "find_text"):
                find_text()
            if (types != "copy" and type != "save"):
                If_update()
        return tmp

    # 创建文本框处的主要部件
    def create_body():
        global content,line_bar
        # 创建行号栏
        line_bar = Text(root, width=3, padx=3, takefocus=0, border=0,
                               background='#DCDCDC', state='disabled')
        line_bar.pack(side='left', fill='y')

        # 创建输入框
        content = Text(root, wrap='none', background='#FFFAFA', undo=True)
        content.pack(expand='yes', fill='both')

        content.bind('<Control-N>', New_file)
        content.bind('<Control-n>', New_file)
        content.bind('<Control-O>', Open_file)
        content.bind('<Control-o>', Open_file)
        content.bind('<Control-S>', Save_file)
        content.bind('<Control-s>', Save_file)
        content.bind('<Control-A>', All)
        content.bind('<Control-a>', All)
        content.bind('<Control-f>', find_text)
        content.bind('<Control-F>', find_text)
        content.bind('<Shift-Control-Z>',lambda x:Edit('恢复'))
        content.tag_configure('active_line', background='#EEEEE0')

        # 创建滚动条
        scroll_barr = Scrollbar(content, orient=VERTICAL)
        scroll_barr["command"] = content.yview
        content["yscrollcommand"] = scroll_barr.set
        scroll_barr.pack(side='right', fill='y')

        scroll_barb = Scrollbar(content, orient=HORIZONTAL)
        scroll_barb["command"] = content.xview
        content["xscrollcommand"] = scroll_barb.set
        scroll_barb.pack(side='bottom', fill='x')

    def If_update():
        global Show_number
        if(Show_number.get()):
            Update_linenum1()
            content.bind("<Return>", lambda x: Update_linenum1())
        else:
            Update_linenum2()
            content.bind("<Return>", lambda x: Update_linenum2())

    def Update_linenum1():
        global line_bar
        row, col = content.index("end").split('.')
        line_num_content = "\n".join([str(i) for i in range(1, int(row)+1)])
        line_bar.config(state='normal')
        line_bar.delete('1.0', 'end')
        line_bar.insert('1.0', line_num_content)
        line_bar.config(state='disabled')

    def Update_linenum2():
        global line_bar
        line_bar.config(state='normal')
        line_bar.delete('1.0', 'end')
        line_bar.config(state='disabled')

    def Highlight_line():
        global Highlight
        if (Highlight.get()):
            content.tag_remove("active_line", 1.0, "end")
            content.tag_add("active_line", "insert linestart", "insert lineend+1c")
            content.after(200, Highlight_line) 
            # 不知道哪里有问题,设了after200，有时还会报超出递归上限的错
        else:
            content.tag_remove("active_line", 1.0, "end")

    def New_file(event=None):
        global content,file_name
        root.title("New")
        content.delete(1.0, END)
        file_name = None

    def Open_file(event=None):
        global file_name
        input_file = filedialog.askopenfilename(
            filetypes=[("所有文件", "*.*"), ("文本文档", "*.txt")])
        if (input_file):
            root.title("%s" % os.path.basename(input_file))
            file_name = input_file
            content.delete(1.0, END)
            with open(input_file, 'r', encoding='gb18030', errors='ignore') as _file:
                content.insert(1.0, _file.read())
            If_update()

    def Save_file(event=None):
        global file_name
        try:
            if not file_name:
                Save()
            else:
                Write_file(file_name)
        except:
            messagebox.showwarning('警告','找不到保存的文件')

    def Save():
        global file_name
        input_file = filedialog.asksaveasfilename(
            filetypes=[("All Files", "*.*"), ("文本文档", "*.txt")])
        if input_file:
            file_name = input_file
            Write_file(file_name)

    def Write_file(file_name):
        try:
            Content = content.get(1.0, 'end')
            with open(file_name, 'w') as the_file:
                the_file.write(Content)
            root.title("%s - Editor" % os.path.basename(file_name))
        except IOError:
            messagebox.showwarning("保存", "保存失败！")

    def All( event=None):
        content.tag_add('sel', '1.0', 'end')
        return "break"

    def change_theme():
        global Theme_choice
        selected_theme = Theme_choice.get()
        bg12 = theme_color.get(selected_theme)
        bg1_color, bg2_color = bg12.split('.')
        content.config(bg=bg2_color)
        line_bar.config(bg=bg1_color)

    def Exit():
        if messagebox.askokcancel("退出?", "           确定退出?"):
            root.destroy()

    def Edit(types, event=None):
        if (types == "撤销"):
            content.event_generate("<<Undo>>")
        elif (types == "恢复"):
            content.event_generate("<<Redo>>")
        elif (types == "剪切"):
            content.event_generate("<<Cut>>")
        elif (types == "复制"):
            content.event_generate("<<Copy>>")
        elif (types == "粘贴"):
            content.event_generate("<<Paste>>")
        if (types != "复制"):
            If_update()
        return "break"
    
    def find_text(event=None):
        Search = Toplevel(root)
        Search.title('查找文本')
        Search.transient(root)
        Search.resizable(False, False)
        Label(Search, text="查找全部:").grid(row=0, column=0, sticky='e')
        Search_widget = Entry(Search, width=25)
        Search_widget.grid(row=0, column=1, padx=2, pady=2, sticky='we')
        Search_widget.focus_set()
        Ignore_value = IntVar()
        Checkbutton(Search, text='忽略大小写', variable=Ignore_value) \
            .grid(row=1, column=1, sticky='e', padx=2, pady=2)

        Button(Search, text="查找", command=
            lambda : search_result(Search_widget.get(), Ignore_value.get(), Search, Search_widget)) \
            .grid(row=0, column=2, sticky='e' + 'w', padx=2, pady=2)
        
        # 关闭查找窗口时消除查找字符的印记
        def Search_result_gone():
            content.tag_remove('match', '1.0', "end")
            Search.destroy()
        Search.protocol('WM_DELETE_WINDOW', Search_result_gone)

        return "break"

    def search_result(key, ignore_case, Search, search_widget):
        content.tag_remove('match', '1.0', "end")
        found = 0
        if key:
            start_pos = '1.0'
            while True:
                # nocase：忽略大小写
                start_pos = content.search(key, start_pos, nocase=ignore_case, stopindex="end")
                if not start_pos:
                    break
                end_pos = '{}+{}c'.format(start_pos, len(key))
                content.tag_add('match', start_pos, end_pos)
                found += 1
                start_pos = end_pos
            content.tag_config('match', foreground='red', background='yellow')
        search_widget.focus_set()
        Search.title('共发现%d个' % found)

    root.protocol('WM_DELETE_WINDOW', Exit)
    create_menu()
    create_shortcut()
    create_body()


root = Tk("SimpleMDIExample")
root.title("多文档文本编辑器")
root.geometry('650x450')
Editor(root)
root.mainloop()
```
